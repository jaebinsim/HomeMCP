

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>HomeMCP Panel ¬∑ Settings</title>
    <link rel="stylesheet" href="/static/panel.css" />
  </head>
  <body>
    <div class="layout">
      <aside class="sidebar">
        <div class="brand">
          <div class="brand__logo">üè†</div>
          <div class="brand__text">
            <div class="brand__title">HomeMCP</div>
            <div class="brand__sub">Core Panel</div>
          </div>
        </div>

        <nav class="nav">
          <a class="nav__item" href="/panel/">Overview</a>
          <a class="nav__item" href="/panel/devices">Devices</a>
          <a class="nav__item nav__item--active" href="/panel/settings">Settings</a>
          <a class="nav__item" href="/docs">API Docs</a>
        </nav>

        <div class="sidebar__footer">
          <div class="kv"><span class="k">File (home-mcp-core/config)</span><span class="v">{{ path }}</span></div>
        </div>
      </aside>

      <main class="main">
        <header class="topbar">
          <div>
            <h1 class="h1">Settings</h1>
            <div class="muted">Preview is masked. Editor saves raw TOML.</div>
          </div>
          <div class="topbar__right">
            <button class="btn ghost" id="themeToggle" title="Toggle theme">
              üñ•Ô∏è Auto
            </button>
            <span class="badge" id="healthBadge">checking‚Ä¶</span>
            <a class="btn" href="/panel/settings">Reload</a>
          </div>
        </header>

        <section class="grid">
          <div class="card">
            <div class="card__title" style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
              <span>Preview</span>
              <button id="revealSecretsBtn" type="button" class="btn small">üôà Hidden</button>
            </div>
            <pre
              class="pre"
              id="settingsPreview"
              data-masked='{{ preview_masked | tojson(indent=2) }}'
              data-raw='{{ preview_raw | tojson(indent=2) }}'
            >{{ preview_masked | tojson(indent=2) }}</pre>
            <div class="muted" id="settingsPreviewHint">Secrets are masked by default.</div>
          </div>

          <div class="card">
            <div class="card__title">Edit settings.toml</div>
            <form method="post" action="/panel/settings" style="margin-top:12px;">
              <textarea name="toml_text" class="textarea" spellcheck="false">{{ raw_toml }}</textarea>
              <div class="row" style="margin-top:10px;">
                <button class="btn primary" type="submit">Save</button>
                <a class="btn" href="/panel/settings">Reload</a>
              </div>
              <p class="muted" style="margin-top:10px;">
                Tip: do NOT commit <code>settings.toml</code>. Keep <code>settings.example.toml</code> in Git.
              </p>
            </form>
          </div>
        </section>
      </main>
    </div>

    <script src="/static/panel.js"></script>
    <script>
      window.HomeMCP && window.HomeMCP.bootSettings && window.HomeMCP.bootSettings();
    </script>
    <script>
      // Settings preview secrets toggle (masked by default)
      (function () {
        const pre = document.getElementById('settingsPreview');
        const btn = document.getElementById('revealSecretsBtn');
        const hint = document.getElementById('settingsPreviewHint');
        if (!pre || !btn) return;

        const masked = pre.getAttribute('data-masked') || '';
        const raw = pre.getAttribute('data-raw') || '';

        const hasRaw = raw.trim().length > 2 && raw.trim() !== 'null';
        if (!hasRaw) {
          btn.disabled = true;
          btn.textContent = 'üôà Hidden';
          if (hint) hint.textContent = 'Secrets are masked. (Raw preview not available.)';
          return;
        }

        let revealed = false;
        const apply = () => {
          pre.textContent = revealed ? raw : masked;
          btn.textContent = revealed ? 'üôâ Shown' : 'üôà Hidden';
          if (hint) {
            hint.textContent = revealed
              ? 'Secrets are visible. Be careful when sharing screenshots.'
              : 'Secrets are masked by default.';
          }
        };

        btn.addEventListener('click', () => {
          if (!revealed) {
            const ok = window.confirm('Reveal secrets in this browser tab?\n\nBe careful when sharing screenshots.');
            if (!ok) return;
          }
          revealed = !revealed;
          apply();
        });

        apply();
      })();
    </script>
  </body>
</html>